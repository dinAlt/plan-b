{"version":3,"names":[],"mappings":"","sources":["plan-b.js"],"sourcesContent":["(function(f){if(typeof exports===\"object\"&&typeof module!==\"undefined\"){module.exports=f()}else if(typeof define===\"function\"&&define.amd){define([],f)}else{var g;if(typeof window!==\"undefined\"){g=window}else if(typeof global!==\"undefined\"){g=global}else if(typeof self!==\"undefined\"){g=self}else{g=this}g.planB = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\n\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar planner_1 = require(\"./planner\");\r\nexports.plan = planner_1.plan;\r\nexports.lastExecuted = planner_1.lastExecuted;\r\n\n},{\"./planner\":2}],2:[function(require,module,exports){\n\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar storage_1 = require(\"./storage\");\r\nvar util_1 = require(\"./util\");\r\nvar validate_1 = require(\"./validate\");\r\nfunction plan(tasks) {\r\n    if (localStorage) {\r\n        gStorage = localStorage;\r\n    }\r\n    else {\r\n        gStorage = storage_1.cookieStorage;\r\n    }\r\n    validate_1.validateTasks(tasks);\r\n    gTasks = tasks;\r\n    gTasks.forEach(function (task) {\r\n        setUpTriggers(task);\r\n    });\r\n}\r\nexports.plan = plan;\r\nfunction lastExecuted(task) {\r\n    var tasks = gTasks.filter(function (t) { return t.name === task; });\r\n    if (tasks.length) {\r\n        return getLastExec(tasks[0]);\r\n    }\r\n    return undefined;\r\n}\r\nexports.lastExecuted = lastExecuted;\r\nvar gTasks;\r\nvar gStorage;\r\nfunction setUpTriggers(task) {\r\n    if (!task.actions || !task.actions.length) {\r\n        return;\r\n    }\r\n    task\r\n        .triggers\r\n        .forEach(function (trigger) {\r\n        if (!planed(task, trigger)) {\r\n            return;\r\n        }\r\n        if (trigger.on === \"init\") {\r\n            setUpTimerActions(task, trigger, trigger.timeout || 0, trigger.repeat || 0);\r\n        }\r\n    });\r\n}\r\nfunction getLastExec(task) {\r\n    var d = Number(gStorage.getItem(\"task:\" + task.name));\r\n    if (d) {\r\n        return new Date(d);\r\n    }\r\n    return undefined;\r\n}\r\nfunction setUpTimerActions(task, trigger, timeout, repeat) {\r\n    if (timeout === void 0) { timeout = 0; }\r\n    if (repeat === void 0) { repeat = 0; }\r\n    var action = function () {\r\n        if (trigger.check && !trigger.check(task.name)) {\r\n            return;\r\n        }\r\n        task.actions.forEach(function (t) { return t(); });\r\n        gStorage.setItem(\"task:\" + task.name, (new Date()).getTime().toString());\r\n    };\r\n    setTimeout(function () {\r\n        action();\r\n        if (repeat) {\r\n            setInterval(action, repeat);\r\n        }\r\n    }, timeout);\r\n}\r\nfunction planed(task, trigger) {\r\n    var lastExec = getLastExec(task);\r\n    if (trigger.plan) {\r\n        if (trigger.plan === \"once\") {\r\n            if (lastExec) {\r\n                return false;\r\n            }\r\n            return true;\r\n        }\r\n        var interval = void 0;\r\n        if (typeof trigger.plan === \"object\") {\r\n            interval = trigger.plan[0] * util_1.intervalToMilliseconds(trigger.plan[1]);\r\n        }\r\n        else {\r\n            interval = util_1.intervalToMilliseconds(trigger.plan);\r\n        }\r\n        if (lastExec && ((Date.now() - lastExec.getTime()) < interval)) {\r\n            return false;\r\n        }\r\n    }\r\n    return true;\r\n}\r\n\n},{\"./storage\":3,\"./util\":4,\"./validate\":5}],3:[function(require,module,exports){\n\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.cookieStorage = {\r\n    getItem: function (key) {\r\n        return getCookie(key);\r\n    },\r\n    setItem: function (key, value) {\r\n        setCookie(key, value, 94608000, \"/\");\r\n    },\r\n};\r\nfunction getCookie(name) {\r\n    return document.cookie.replace(new RegExp(\"(?:(?:^|.*;\\\\s*)\" + encodeURIComponent(name) + \"\\\\s*\\\\=\\\\s*([^;]*).*$)|^.*$\"), \"$1\");\r\n}\r\nfunction setCookie(name, value, expiration, path) {\r\n    if (path === void 0) { path = \"/\"; }\r\n    var cookie = encodeURIComponent(name) + \"=\" + encodeURIComponent(value) + \"; path=\" + encodeURIComponent(path) + \";\";\r\n    if (expiration) {\r\n        if (typeof expiration === \"number\") {\r\n            cookie += \" max-age=\" + expiration;\r\n        }\r\n        else {\r\n            cookie += \" expires=\" + expiration.toUTCString();\r\n        }\r\n    }\r\n    document.cookie = cookie;\r\n}\r\n\n},{}],4:[function(require,module,exports){\n\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction intervalToMilliseconds(interval) {\r\n    switch (interval) {\r\n        case \"second\":\r\n            return 1000;\r\n        case \"minute\":\r\n            return 60 * intervalToMilliseconds(\"second\");\r\n        case \"hour\":\r\n            return 60 * intervalToMilliseconds(\"minute\");\r\n        case \"day\":\r\n            return 24 * intervalToMilliseconds(\"hour\");\r\n        case \"week\":\r\n            return 7 * intervalToMilliseconds(\"day\");\r\n        default:\r\n            throw new Error(\"Invalid \\\"interval\\\" value \" + interval);\r\n    }\r\n}\r\nexports.intervalToMilliseconds = intervalToMilliseconds;\r\n\n},{}],5:[function(require,module,exports){\n\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar util_1 = require(\"./util\");\r\nfunction validateActions(task) {\r\n    task.actions.forEach(function (t) {\r\n        if (typeof t !== \"function\") {\r\n            throw new Error(\"Action should be a function, task: \\\"\" + task.name + \"\\\"\");\r\n        }\r\n    });\r\n}\r\nfunction validateTriggers(task) {\r\n    task\r\n        .triggers\r\n        .forEach(function (t) {\r\n        if (t.on !== \"init\") {\r\n            throw new Error(\"Triggers \\\"on\\\" property should be one of (\\\"init\\\",), got \" + t.on + \", task: \\\"\" + task.name + \"\\\"\");\r\n        }\r\n        if (t.repeat && typeof t.repeat !== \"number\") {\r\n            throw new Error(\"Triggers \\\"repeat.each\\\" property should be a number, task: \\\"\" + task.name + \"\\\"\");\r\n        }\r\n        validateTriggerPlan(t, task);\r\n    });\r\n}\r\nfunction validateTriggerPlan(trigger, task) {\r\n    if (trigger.plan) {\r\n        if (trigger.plan === \"once\") {\r\n            return;\r\n        }\r\n        if (typeof trigger.plan === \"string\") {\r\n            util_1.intervalToMilliseconds(trigger.plan);\r\n            return;\r\n        }\r\n        if (trigger.plan.length &&\r\n            (trigger.plan.length === 2) && (typeof trigger.plan[0] === \"number\")) {\r\n            util_1.intervalToMilliseconds(trigger.plan[1]);\r\n            return;\r\n        }\r\n        throw new Error(\"Invalid trigger plan: \" + trigger.plan + \", task: \" + task.name);\r\n    }\r\n}\r\nfunction validateTasks(tasks) {\r\n    tasks.forEach(function (t) {\r\n        if (!t.name) {\r\n            throw new Error(\"Task name required\");\r\n        }\r\n        validateTriggers(t);\r\n        validateActions(t);\r\n    });\r\n}\r\nexports.validateTasks = validateTasks;\r\n\n},{\"./util\":4}]},{},[1])(1)\n});\n"],"file":"plan-b.js"}